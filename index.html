<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Clock For Kindle</title>
        <style>
            @font-face {
                font-family: TIME;
                src: url("time.ttf") format("truetype"); /* You'll need to make sure time.ttf is available */
            }

            * {
                margin: 0;
                padding: 0;
            }

            body {
                height: 100vh;
                width: 100%;
                text-align: center;
                overflow: hidden;
                background-color: white; /*  good practice to set a background color */
            }

            .app {
                position: absolute;
                top: 50%;
                left: 50%;
                -webkit-transform-origin: 0 0;
            }

            .time {
                font-family: TIME;
                margin: 1rem 0;
            }

            .date {
                white-space: nowrap;
            }

            .cn-date {
            }
        </style>
    </head>

    <body>
        <div class="app">
            <div class="date"></div>
            <div class="time"></div>
            <div class="cn-date"></div>
        </div>

        <script>
            // calendar.min.js content (replace this with the actual content of calendar.min.js)
            // ---  I am placing a placeholder here, you need the actual calendar.min.js code ---
            const calendar = {
                solar2lunar: function (year, month, day) {
                    // Placeholder implementation (replace with actual calendar.min.js logic)
                    console.warn(
                        "calendar.solar2lunar called, but this is a placeholder.  You need to include the actual calendar.min.js content."
                    );
                    return {
                        IMonthCn: "PlaceholderMonth",
                        IDayCn: "PlaceholderDay",
                        Animal: "PlaceholderAnimal",
                    };
                },
            };
            // --- End of calendar.min.js placeholder ---
        </script>

        <script>
            // index.js content
            const domApp = document.querySelector(".app");
            const domTime = document.querySelector(".time");
            const domDate = document.querySelector(".date");
            const domCnDate = document.querySelector(".cn-date");

            function geturl(url) {
                const arr = url.split("?");

                if (!arr[1]) {
                    return {};
                }

                const res = arr[1].split("&");
                const items = {};
                for (let i = 0; i < res.length; i++) {
                    const a = res[i].split("=");
                    items[a[0]] = a[1];
                }
                return items;
            }

            function formatDate(date, fmt = "yyyy-MM-dd") {
                if (!date) {
                    return "";
                }
                if (typeof date === "number" || typeof date === "string") {
                    date = new Date(Number(date));
                }
                const o = {
                    "M+": date.getMonth() + 1,
                    "d+": date.getDate(),
                    "h+": date.getHours(),
                    "m+": date.getMinutes(),
                    "s+": date.getSeconds(),
                    "q+": Math.floor((date.getMonth() + 3) / 3),
                    S: date.getMilliseconds(),
                };
                if (/(y+)/.test(fmt))
                    fmt = fmt.replace(
                        RegExp.$1,
                        `${date.getFullYear()}`.substr(4 - RegExp.$1.length)
                    );
                for (const k in o)
                    if (new RegExp(`(${k})`).test(fmt))
                        fmt = fmt.replace(
                            RegExp.$1,
                            RegExp.$1.length === 1
                                ? o[k]
                                : `00${o[k]}`.substr(`${o[k]}`.length)
                        );
                return fmt;
            }

            function render() {
                // 保证 中国时区显示时间。不设置在一些 kindle 会出现时区问题
                const time = new Date();
                const len = time.getTime();
                const offset = time.getTimezoneOffset() * 60000; //本地时间与GMT时间差值
                const utcTime = len + offset; //格林尼治时间
                const date = new Date(utcTime + 3600000 * 9);

                const lunar = calendar.solar2lunar(
                    date.getUTCFullYear(),
                    date.getUTCMonth() + 1,
                    date.getUTCDate()
                );
                const dateText = `${formatDate(date, "yyyy.M.d")} ${
                    urlQuery.l == "en"
                        ? ["SUN", "MON", "TUES", "WED", "THUR", "FRI", "SAT"][
                              date.getDay()
                          ]
                        : "星期" +
                          ["日", "一", "二", "三", "四", "五", "六"][
                              date.getDay()
                          ]
                }`;
                const timeText = `${String(date.getHours()).padStart(
                    2,
                    "0"
                )}:${String(date.getMinutes()).padStart(2, "0")}`; // added padding
                // const cnDateText = `${lunar.IMonthCn}${lunar.IDayCn} ${lunar.Animal}年`;

                if (domDate.innerHTML != dateText) domDate.innerHTML = dateText;
                if (domTime.innerHTML != timeText) domTime.innerHTML = timeText;
                // if (domCnDate.innerHTML != cnDateText)
                //     domCnDate.innerHTML = cnDateText;
            }

            const urlQuery = geturl(location.href);
            const config = {
                fontSize: +(urlQuery.fs || 7),
                rotate: urlQuery.r,
                lang: urlQuery.l,
            };

            domTime.style.fontSize = config.fontSize + "rem";
            domDate.style.fontSize = config.fontSize / 2.5 + "rem";
            domCnDate.style.fontSize = config.fontSize / 4 + "rem";
            domApp.style.cssText = `-webkit-transform: rotate(${
                config.rotate || 0
            }deg) translate3d(-50%,-50%,0)`;

            render();
            setInterval(() => {
                render();
            }, 1000);
        </script>
    </body>
</html>
